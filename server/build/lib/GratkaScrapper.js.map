{"version":3,"sources":["../../src/lib/GratkaScrapper.js"],"names":["getGratkaScrape","offersObj","getGratkaOffersObj","url","axios","get","html","data","$","cheerio","load","offers","pageLimiter","children","prev","text","pageLimit","parseInt","dt","Date","offersFromMongoDB","Offer","find","sort","scrapeDate","exec","console","log","lastScrapedOfferLink","length","link","arrayFromScrapes","i","currentLink","attr","price","replace","title","img","type","includes","localization","date","substr","require","mongoose","model"],"mappings":"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","file":"GratkaScrapper.js","sourcesContent":["const axios = require(\"axios\");\r\nconst cheerio = require(\"cheerio\");\r\nconst mongoose = require(\"mongoose\");\r\nrequire(\"../models/Offer\");\r\nconst Offer = mongoose.model(\"Offers\");\r\n\r\n// Starting point to scraping function\r\nexport async function getGratkaOffersObj() {\r\n  const offersObj = await getGratkaScrape(\r\n    \"https://gratka.pl/nieruchomosci/mieszkania/katowice/?page=1\"\r\n  );\r\n  return offersObj;\r\n}\r\n\r\n// Scraping function\r\nexport async function getGratkaScrape(url) {\r\n  const { data: html } = await axios.get(url);\r\n  const $ = cheerio.load(html);\r\n  const offers = $(\r\n    \".content__listingContainer .content__listing .teaserEstate\"\r\n  );\r\n\r\n  // Get last page value\r\n  const pageLimiter = $(\".pagination\")\r\n    .children(\".pagination__nextPage\")\r\n    .prev()\r\n    .text();\r\n  const pageLimit = parseInt(pageLimiter);\r\n\r\n  const dt = new Date();\r\n\r\n  let offersFromMongoDB;\r\n\r\n  try {\r\n    offersFromMongoDB = await Offer.find().sort({ scrapeDate: -1 }).exec();\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n\r\n  const lastScrapedOfferLink =\r\n    offersFromMongoDB.length !== 0\r\n      ? offersFromMongoDB[offersFromMongoDB.length - 1].link\r\n      : \"\";\r\n\r\n  // Add only new offers to offersObj Array\r\n  const arrayFromScrapes = Array.from(offers);\r\n  const offersObj = [];\r\n\r\n  // for (let i = 0; i < arrayFromScrapes.length; i++) {\r\n  for (let i = 0; i < 1; i++) {\r\n    const currentLink = $(arrayFromScrapes[i])\r\n      .find(\".teaserEstate__photo a\")\r\n      .attr(\"href\");\r\n\r\n    const price = $(arrayFromScrapes[i])\r\n      .find(\".teaserEstate__priceBox .teaserEstate__price\")\r\n      .text()\r\n      .replace(/\\s\\s+/g, \"\")\r\n      .replace(\r\n        $(arrayFromScrapes[i])\r\n          .find(\r\n            \".teaserEstate__priceBox .teaserEstate__price .teaserEstate__additionalPrice\"\r\n          )\r\n          .text()\r\n          .replace(/\\s\\s+/g, \"\"),\r\n        \"\"\r\n      );\r\n\r\n    console.log({\r\n      title: $(arrayFromScrapes[i])\r\n        .find(\".teaserEstate__title .teaserEstate__anchor\")\r\n        .text()\r\n        .replace(/\\s\\s+/g, \"\"),\r\n      link: $(arrayFromScrapes[i]).find(\".teaserEstate__photo a\").attr(\"href\"),\r\n      img: $(arrayFromScrapes[i])\r\n        .find(\".teaserEstate__photo a img\")\r\n        .attr(\"data-src\"),\r\n      price: price.replace(\"/mc\", \"\"),\r\n      type: price.includes(\"/mc\")\r\n        ? \"Mieszkania » Wynajem\"\r\n        : price.includes(\"Zapytaj o cenę\")\r\n        ? \"Mieszkania » Zamiana\"\r\n        : \"Mieszkania » Sprzedaż\",\r\n      localization: $(arrayFromScrapes[i])\r\n        .find(\".teaserEstate__mainInfo .teaserEstate__localization\")\r\n        .text()\r\n        .replace(/\\s\\s+/g, \"\"),\r\n      date: $(arrayFromScrapes[i])\r\n        .find(\".teaserEstate__details .teaserEstate__info\")\r\n        .text()\r\n        .replace(/^\\s+|\\s+$/g, \"\")\r\n        .replace(\"Aktualizacja: \", \"\")\r\n        .substr(0, 10)\r\n        .replace(/\\./g, \"-\"),\r\n    });\r\n\r\n    // if (currentLink !== lastScrapedOfferLink) {\r\n    //   offersObj.push({\r\n    //     title: $(arrayFromScrapes[i])\r\n    //       .find('[data-cy=\"listing-ad-title\"]')\r\n    //       .text()\r\n    //       .replace(/\\s\\s+/g, \"\"),\r\n    //     link: $(arrayFromScrapes[i])\r\n    //       .find('[data-cy=\"listing-ad-title\"]')\r\n    //       .attr(\"href\"),\r\n    //     img: $(arrayFromScrapes[i]).find(\"img\").attr(\"src\"),\r\n    //     price: $(arrayFromScrapes[i]).find(\".td-price strong\").text(),\r\n    //     type: $(arrayFromScrapes[i])\r\n    //       .find(\".title-cell p small\")\r\n    //       .text()\r\n    //       .replace(/\\s\\s+/g, \"\"),\r\n    //     localization: $(arrayFromScrapes[i])\r\n    //       .find(\"[data-icon='location-filled']\")\r\n    //       .parent()\r\n    //       .text()\r\n    //       .replace(/\\s\\s+/g, \"\"),\r\n    //     date: `${$(arrayFromScrapes[i])\r\n    //       .find(\"[data-icon='clock']\")\r\n    //       .parent()\r\n    //       .text()\r\n    //       .replace(/^\\s+|\\s+$/g, \"\")\r\n    //       .replace(\"  \", \"-\")}-${dt.getFullYear()}`,\r\n    //   });\r\n    // } else {\r\n    //   break;\r\n    // }\r\n  }\r\n\r\n  // // Recursive iteration through all pages the get all the data\r\n  // if (offersObj.length < 1) {\r\n  //   return offersObj;\r\n  // } else {\r\n  //   // Regex which creates next page number from current url\r\n  //   const nextPageNumber = parseInt(url.match(/page=(\\d+)$/)[1], 10) + 1;\r\n  //   // If we didnt reach last page\r\n  //   if (nextPageNumber <= 10) {\r\n  //     const nextUrl = `https://www.olx.pl/nieruchomosci/mieszkania/katowice/?page=${nextPageNumber}`;\r\n  //     // Concat new values to offersObj array\r\n  //     return [...offersObj, ...(await getOlxScrape(nextUrl))];\r\n  //   } else {\r\n  //     return offersObj;\r\n  //   }\r\n  // }\r\n}\r\n"]}